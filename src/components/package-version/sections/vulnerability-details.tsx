import { ComplexCard } from "@/components/ui/complex-card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CACHE_TAGS } from "@/consts";
import { getTransitiveDependenies } from "@/lib";
import { getVlnsForMultiplePkgs } from "@/lib/ovs";
import { NpmPackageVersion } from "@/types";
import { VulnerabilitiesList } from "../components";

type VulnerabilityDetailsProps = {
  packageName: string;
  packageMetadata: NpmPackageVersion;
};

export const VulnerabilityDetails = async ({
  packageName,
  packageMetadata,
}: VulnerabilityDetailsProps) => {
  const topLevelDeps = {
    ...packageMetadata.dependencies,
  };
  const transitiveDependencies = await getTransitiveDependenies(topLevelDeps);
  const ovsData = await getVlnsForMultiplePkgs(
    `${CACHE_TAGS.ovsIncludingTransitive}:${packageName}@${packageMetadata.version}`,
    [packageMetadata, ...transitiveDependencies]
  );
  const directVlns = ovsData.filter((ovsItem) => ovsItem.packageName === packageName);
  const transitiveVlns = ovsData.filter((ovsItem) => ovsItem.packageName !== packageName);

  return (
    <ComplexCard
      title="Security Details"
      description={`Comprehensive list of direct or transitive vulnerabilities for version ${packageMetadata.version} of the package ${packageName}.`}
    >
      <Tabs defaultValue="allVulnerabilities" className="w-full">
        <TabsList className="w-full">
          <TabsTrigger value="allVulnerabilities" className="cursor-pointer">
            <h3 className="text-xs lg:text-sm">All</h3>
          </TabsTrigger>
          <TabsTrigger value="transitiveDependencies" className="cursor-pointer">
            <h3 className="text-xs lg:text-sm">Transitive Dependencies</h3>
          </TabsTrigger>
          <TabsTrigger value="package" className="cursor-pointer">
            <h3 className="text-xs lg:text-sm">Package</h3>
          </TabsTrigger>
        </TabsList>
        <TabsContent value="allVulnerabilities">
          <div className="flex flex-col gap-4">
            <div className="flex flex-col">
              <h3 className="mt-6 text-lg lg:text-xl font-semibold">
                All Security Vulnerabilities
              </h3>
              <p className="text-xs lg:text-sm text-gray-500">
                All the vulnerabilities related to the version {packageMetadata.version} of the
                package
              </p>
            </div>
            <VulnerabilitiesList vulnerabilities={ovsData} />
          </div>
        </TabsContent>
        <TabsContent value="transitiveDependencies">
          <div className="flex flex-col gap-4">
            <div className="flex flex-col">
              <h3 className="mt-6 text-lg lg:text-xl font-semibold">Transitive Vulnerabilities</h3>
              <p className="text-xs lg:text-sm text-gray-500">
                Overview of the indirect vulnerabilities associated with the transitive dependencies
                of version {packageMetadata.version} of package {packageName}.
              </p>
            </div>
            <VulnerabilitiesList vulnerabilities={transitiveVlns} />
          </div>
        </TabsContent>
        <TabsContent value="package">
          <div className="flex flex-col gap-4">
            <div className="flex flex-col">
              <h3 className="mt-6 text-lg lg:text-xl font-semibold">Direct Vulnerabilities</h3>
              <p className="text-xs lg:text-sm text-gray-500">
                A compilation of security vulnerabilities that are specifically associated with
                version {packageMetadata.version} of package {packageName}, excluding any transitive
                vulnerabilities.
              </p>
            </div>
            <VulnerabilitiesList vulnerabilities={directVlns} />
          </div>
        </TabsContent>
      </Tabs>
    </ComplexCard>
  );
};
